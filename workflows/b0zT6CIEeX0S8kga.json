{
  "active": false,
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-10-17T16:50:24.624Z",
  "id": "b0zT6CIEeX0S8kga",
  "isArchived": true,
  "meta": null,
  "name": "ZEI_widget",
  "nodes": [
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "=(function(){\n  if (window.MobilvendorWidgetLoaded) return;\n  window.MobilvendorWidgetLoaded = true;\n\n  const WEBHOOK_URL = \"https://n8n.mobilvendor.com/webhook/1c8d45e7-24a6-4d80-b05f-867c33711988\";\n  const BOT_IMG = \"https://ik.imagekit.io/nm4jeymx5/Asistente-03-Mobilvendor.jpg?updatedAt=1760720233657\";\n\n  const widget = document.createElement(\"div\");\n  widget.id = \"mv-widget\";\n  widget.innerHTML = `\n    <img id=\"mv-bot\" src=\"${BOT_IMG}\" alt=\"Asesor Mobilvendor\"/>\n    <div id=\"mv-chatbox\" style=\"display:none; flex-direction:column;\">\n      <div id=\"mv-header\">\n        <div class=\"mv-header-top\">\n          <img src=\"${BOT_IMG}\" alt=\"ZEI Bot\" class=\"mv-avatar\"/>\n          <span class=\"mv-title\">Asesor Comercial Mobilvendor</span>\n        </div>\n        <div id=\"mv-header-bar\"></div>\n      </div>\n      <div id=\"mv-messages\"></div>\n      <div id=\"mv-footer\">\n        <input id=\"mv-input\" type=\"text\" placeholder=\"Escribe tu mensaje...\" autocomplete=\"off\"/>\n        <button id=\"mv-send\" title=\"Enviar\">\n          <svg width=\"24\" height=\"24\" fill=\"#fff\" viewBox=\"0 0 24 24\"><path d=\"M2 21l21-9L2 3v7l15 2-15 2v7z\"></path></svg>\n        </button>\n      </div>\n    </div>\n  `;\n  document.body.appendChild(widget);\n\n  const style = document.createElement(\"style\");\n  style.textContent = `\n    #mv-widget { position:fixed; bottom:24px; right:24px; z-index:99999; font-family:'Segoe UI',Arial,sans-serif;}\n    \n    #mv-bot {\n      width:72px;height:72px;border-radius:50%;cursor:pointer;\n      box-shadow:0 10px 30px rgba(0,55,255,0.20);\n      transition:transform 0.18s ease, box-shadow 0.18s ease;\n      border:4px solid #fff;background:#fff;\n    }\n    #mv-bot:hover { transform:scale(1.07); box-shadow:0 12px 36px rgba(0,55,255,0.28); }\n    \n    #mv-chatbox {\n      position:fixed; bottom:110px; right:32px; width:380px; background:#fff;\n      border-radius:22px;box-shadow:0 10px 50px rgba(0,0,0,0.15);\n      flex-direction:column;display:none;overflow:hidden;\n    }\n    \n    /* Header con degradado azul */\n    #mv-header {\n      background:linear-gradient(90deg, #0037ff 0%, #063bce 100%);\n      padding:12px 14px 0 14px;\n    }\n    \n    #mv-header .mv-header-top {\n      display:flex;align-items:center;gap:10px;\n      padding:8px 6px 10px 6px;\n    }\n    \n    #mv-header .mv-avatar {\n      width:26px;height:26px;border-radius:50%;\n      border:2px solid rgba(255,255,255,0.75);\n      box-shadow:0 0 0 2px rgba(0,0,0,0.08);\n      background:#fff;\n    }\n    \n    /* TÃ­tulo en blanco sobre degradado */\n    #mv-header .mv-title {\n      color:#ffffff;\n      font-weight:700;font-size:16px;letter-spacing:0.3px;\n      text-shadow:0 1px 3px rgba(0,0,0,0.25);\n    }\n    \n    /* Barra indicadora (normal: #0037ff, activo: #002B49) */\n    #mv-header-bar {\n      height:4px;width:100%;\n      background:#0037ff;\n      transition:background-color 0.15s ease;\n    }\n    #mv-header-bar.active {\n      background:#002B49;\n    }\n    \n    #mv-messages {\n      max-height:420px;min-height:140px;overflow-y:auto;padding:14px 12px;background:#fafafa;\n      display:flex;flex-direction:column;gap:10px;\n    }\n    \n    /* Scrollbar azul */\n    #mv-messages::-webkit-scrollbar { width:8px; }\n    #mv-messages::-webkit-scrollbar-track { background:#e9eefc;border-radius:10px; }\n    #mv-messages::-webkit-scrollbar-thumb {\n      background:#0037ff;border-radius:10px;\n    }\n    #mv-messages::-webkit-scrollbar-thumb:hover { background:#002B49; }\n    \n    .mv-message-container {\n      display:flex;\n      margin-bottom:2px;\n    }\n    .mv-message-container.user {\n      justify-content:flex-end;\n    }\n    .mv-message-container.bot {\n      justify-content:flex-start;\n    }\n    \n    .mv-message {\n      background:#fffde7;border:1px solid rgba(255,179,0,0.15);\n      border-radius:12px 12px 12px 6px;padding:9px 12px 10px 12px;max-width:75%;\n      word-break:break-word;box-shadow:0 1px 2px rgba(0,0,0,0.06);position:relative;\n    }\n    \n    .mv-message-container.user .mv-message {\n      background:#e8f0ff;border:1px solid rgba(0,55,255,0.20);\n      border-radius:12px 12px 6px 12px;\n    }\n    \n    .mv-message-sender {\n      font-size:12px;font-weight:700;color:#0037ff;margin-bottom:4px;display:block;\n    }\n    \n    .mv-message-container.user .mv-message-sender {\n      color:#063bce;\n    }\n    \n    .mv-message-text {\n      font-size:14px;line-height:1.5;color:#333;white-space:pre-wrap;\n      text-align:justify;text-justify:inter-word;\n    }\n    \n    .mv-message-text a {\n      color:#0037ff;text-decoration:underline;\n    }\n    \n    .mv-message-text a:hover {\n      color:#002B49;\n    }\n    \n    .mv-message-time {\n      font-size:10px;color:#999;margin-top:4px;text-align:right;display:block;\n    }\n    \n    #mv-footer {\n      display:flex;align-items:center;gap:8px;\n      border-top:1px solid rgba(0,55,255,0.15);\n      background:#fff;padding:10px 12px 12px;\n    }\n    \n    #mv-input {\n      flex:1;padding:12px;border:1.5px solid #0037ff;\n      border-radius:12px;font-size:15px;outline:none;background:#fff;\n      transition:box-shadow 0.15s ease, border-color 0.15s ease;\n    }\n    #mv-input:focus {\n      border-color:#002B49;\n      box-shadow:0 0 0 3px rgba(0,43,73,0.18);\n    }\n    #mv-input:disabled { opacity:0.6;cursor:not-allowed; }\n    \n    #mv-send {\n      width:44px;height:44px;border:none;border-radius:12px;cursor:pointer;\n      background:#0037ff;color:#fff;display:flex;align-items:center;justify-content:center;\n      box-shadow:0 2px 8px rgba(0,55,255,0.25);\n      transition:transform 0.12s ease, background-color 0.12s ease, box-shadow 0.12s ease;\n    }\n    #mv-send:hover { transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,55,255,0.35); }\n    #mv-send:active { background:#002B49;transform:translateY(0);box-shadow:0 2px 8px rgba(0,43,73,0.35); }\n    #mv-send:disabled { opacity:0.6;cursor:not-allowed; }\n    \n    @media (max-width: 480px){\n      #mv-chatbox{ right:16px; width: calc(100vw - 32px); }\n    }\n  `;\n  document.head.appendChild(style);\n\n  const bot = widget.querySelector(\"#mv-bot\");\n  const chatbox = widget.querySelector(\"#mv-chatbox\");\n  const input = widget.querySelector(\"#mv-input\");\n  const messages = widget.querySelector(\"#mv-messages\");\n  const sendBtn = widget.querySelector(\"#mv-send\");\n  const headerBar = widget.querySelector(\"#mv-header-bar\");\n\n  const sessionKey = \"zeiSessionId\";\n  let sessionId = localStorage.getItem(sessionKey);\n  if (!sessionId) {\n    sessionId = \"session_\" + Date.now() + \"_\" + Math.random().toString(36).substring(2, 8);\n    localStorage.setItem(sessionKey, sessionId);\n  }\n\n  bot.addEventListener(\"click\", () => {\n    const showing = chatbox.style.display !== \"none\";\n    chatbox.style.display = showing ? \"none\" : \"flex\";\n    if (!showing && !chatbox.dataset.greeted) {\n      appendMessage(\"Asesor\", \"Â¡Hola! ðŸ‘‹ Soy tu asesor comercial de Mobilvendor. Â¿En quÃ© puedo ayudarte hoy?\");\n      chatbox.dataset.greeted = true;\n    }\n    if (!showing) input.focus();\n  });\n\n  // Barra activa al enfocar input\n  input.addEventListener(\"focus\", () => headerBar.classList.add(\"active\"));\n  input.addEventListener(\"blur\", () => headerBar.classList.remove(\"active\"));\n\n  function sanitize(text){\n    const div = document.createElement(\"div\");\n    div.textContent = String(text ?? \"\");\n    return div.innerHTML;\n  }\n\n  function sanitizeWithLinks(text){\n    // Permite solo etiquetas <a> con href vÃ¡lidos\n    const tempDiv = document.createElement(\"div\");\n    tempDiv.innerHTML = String(text ?? \"\");\n    \n    // Extraer todos los enlaces vÃ¡lidos\n    const links = tempDiv.querySelectorAll(\"a[href]\");\n    const linkMap = new Map();\n    \n    links.forEach((link, index) => {\n      const href = link.getAttribute(\"href\");\n      const linkText = link.textContent;\n      if (href && href.match(/^https?:\\/\\//)) {\n        const placeholder = `__LINK_${index}__`;\n        linkMap.set(placeholder, { href, text: linkText });\n        link.replaceWith(placeholder);\n      }\n    });\n    \n    // Sanitizar el texto completo\n    let sanitizedText = sanitize(tempDiv.textContent);\n    \n    // Restaurar los enlaces\n    linkMap.forEach((linkData, placeholder) => {\n      const safeHref = sanitize(linkData.href);\n      const safeText = sanitize(linkData.text);\n      const linkHtml = `<a href=\"${safeHref}\" target=\"_blank\" rel=\"noopener noreferrer\">${safeText}</a>`;\n      sanitizedText = sanitizedText.replace(placeholder, linkHtml);\n    });\n    \n    return sanitizedText;\n  }\n\n  function sendMessage() {\n    const userMsg = input.value.trim();\n    if (!userMsg) return;\n    appendMessage(\"TÃº\", userMsg, true);\n    input.value = \"\"; \n    input.disabled = true;\n    sendBtn.disabled = true;\n    \n    fetch(WEBHOOK_URL, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify({ sessionId, message: userMsg })\n    })\n    .then(r => r.json())\n    .then(data => {\n      let response = \"\";\n      if (Array.isArray(data)) {\n        response = data[0]?.output ?? data[0]?.message ?? \"\";\n      } else {\n        response = data?.output ?? data?.reply ?? data?.message ?? \"\";\n      }\n      if (response) appendMessage(\"Asesor\", response);\n      else appendMessage(\"Asesor\", \"RecibÃ­ la solicitud, pero no llegÃ³ contenido para mostrar.\");\n    })\n    .catch(err => {\n      console.error(err);\n      appendMessage(\"Asesor\", \"Lo siento, hubo un error al procesar tu mensaje. Por favor intenta nuevamente.\");\n    })\n    .finally(()=>{ \n      input.disabled = false;\n      sendBtn.disabled = false;\n      input.focus(); \n    });\n  }\n\n  input.addEventListener(\"keypress\", e => { if (e.key === \"Enter\") sendMessage(); });\n  sendBtn.addEventListener(\"click\", sendMessage);\n\n  function appendMessage(sender, text, isUser = false) {\n    const container = document.createElement(\"div\");\n    container.className = `mv-message-container ${isUser ? 'user' : 'bot'}`;\n    \n    const now = new Date();\n    const time = now.getHours().toString().padStart(2, '0') + ':' + \n                 now.getMinutes().toString().padStart(2, '0');\n    \n    const sanitizedSender = sanitize(sender);\n    const sanitizedText = isUser ? sanitize(text) : sanitizeWithLinks(text);\n    \n    container.innerHTML = `\n      <div class=\"mv-message\">\n        <span class=\"mv-message-sender\">${sanitizedSender}</span>\n        <div class=\"mv-message-text\">${sanitizedText}</div>\n        <span class=\"mv-message-time\">${time}</span>\n      </div>\n    `;\n    \n    messages.appendChild(container);\n    messages.scrollTop = messages.scrollHeight;\n  }\n})();",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/javascript"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        320,
        0
      ],
      "id": "453a4220-219c-455f-a144-91faa4b41796",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "path": "widget-zei",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        80,
        0
      ],
      "id": "dcab50ef-77ca-4630-a056-a055a932632e",
      "name": "Webhook",
      "webhookId": "c3a6035e-6f03-4224-86d5-1576b5827ee5"
    }
  ],
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "n8n.mobilvendor.com",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36",
            "accept": "*/*",
            "accept-encoding": "gzip, deflate, br, zstd",
            "accept-language": "en-US,en;q=0.9",
            "if-none-match": "W/\"1c97-LAFCeY36FCC9YRvQ3VNqv30c5JA\"",
            "sec-ch-ua": "\"Google Chrome\";v=\"141\", \"Not?A_Brand\";v=\"8\", \"Chromium\";v=\"141\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"Windows\"",
            "sec-fetch-dest": "script",
            "sec-fetch-mode": "no-cors",
            "sec-fetch-site": "cross-site",
            "sec-fetch-storage-access": "none",
            "x-forwarded-for": "172.19.0.1",
            "x-forwarded-host": "n8n.mobilvendor.com",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "b914648e9224",
            "x-real-ip": "172.19.0.1"
          },
          "params": {},
          "query": {},
          "body": {},
          "webhookUrl": "https://n8n.mobilvendor.com/webhook/widget-zei",
          "executionMode": "production"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-10-17T16:50:24.636Z",
      "updatedAt": "2025-10-17T16:50:24.636Z",
      "role": "workflow:owner",
      "workflowId": "b0zT6CIEeX0S8kga",
      "projectId": "IcIKCrtLDXlTBTP5"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-12-22T17:03:53.000Z",
  "versionId": "647a49d9-becb-4e47-9fb0-d7328b9413c7"
}